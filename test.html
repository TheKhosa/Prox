<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Interactive Browser - 60fps</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            overflow: hidden;
            background-color: #000;
            font-family: Arial, sans-serif;
        }

        #container {
            position: relative;
            width: 100vw;
            height: 100vh;
        }

        #liveView {
            width: 100%;
            height: 100%;
            object-fit: fill;
            display: block;
            cursor: pointer;
        }

        #clickIndicator {
            position: fixed;
            width: 30px;
            height: 30px;
            border: 3px solid #00ff00;
            border-radius: 50%;
            pointer-events: none;
            display: none;
            z-index: 999;
            transform: translate(-50%, -50%);
            animation: pulse 0.6s ease-out;
        }

        @keyframes pulse {
            0% { transform: translate(-50%, -50%) scale(0.3); opacity: 1; }
            100% { transform: translate(-50%, -50%) scale(1.5); opacity: 0; }
        }
    </style>
</head>
<body>
    <div id="container">
        <div id="clickIndicator"></div>
        <img id="liveView" src="" alt="Interactive Browser">
    </div>

    <script src="/socket.io/socket.io.js"></script>
    <script>
        const SERVER_URL = 'http://localhost:3001';
        let viewportWidth = window.innerWidth;
        let viewportHeight = window.innerHeight;
        let isProcessing = false;

        // Connect to socket.io
        const socket = io(SERVER_URL);

        socket.on('connect', () => {
            console.log('Connected to server - receiving 60fps stream');
        });

        // Receive frames from server
        socket.on('frame', (data) => {
            const img = document.getElementById('liveView');
            img.src = 'data:image/jpeg;base64,' + data.image;
        });

        socket.on('disconnect', () => {
            console.log('Disconnected from server');
        });

        // URL-based navigation
        let lastUrl = '';

        function checkUrlNavigation() {
            const params = new URLSearchParams(window.location.search);
            const urlParam = params.get('url');

            if (urlParam && urlParam !== lastUrl) {
                lastUrl = urlParam;
                navigateToUrl(urlParam);
            }
        }

        async function navigateToUrl(url) {
            // Add protocol if missing
            if (!url.startsWith('http://') && !url.startsWith('https://')) {
                url = 'https://' + url;
            }

            console.log('Navigating to:', url);

            try {
                await fetch(`${SERVER_URL}/navigate`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ url })
                });
            } catch (error) {
                console.error('Navigation error:', error);
            }
        }

        // Check URL on load and when it changes
        checkUrlNavigation();
        window.addEventListener('popstate', checkUrlNavigation);

        // Monitor for URL changes (for programmatic changes)
        setInterval(checkUrlNavigation, 1000);

        function showClickIndicator(x, y) {
            const indicator = document.getElementById('clickIndicator');
            indicator.style.left = x + 'px';
            indicator.style.top = y + 'px';
            indicator.style.display = 'block';

            setTimeout(() => {
                indicator.style.display = 'none';
            }, 600);
        }

        // Handle click
        document.getElementById('liveView').addEventListener('click', async (event) => {
            if (isProcessing) return;

            const img = document.getElementById('liveView');
            const rect = img.getBoundingClientRect();

            const x = event.clientX - rect.left;
            const y = event.clientY - rect.top;

            const scaleX = viewportWidth / rect.width;
            const scaleY = viewportHeight / rect.height;

            const actualX = Math.round(x * scaleX);
            const actualY = Math.round(y * scaleY);

            console.log(`Click at: ${actualX}, ${actualY}`);
            showClickIndicator(event.clientX, event.clientY);

            isProcessing = true;

            try {
                await fetch(`${SERVER_URL}/click`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        x: actualX,
                        y: actualY,
                        width: viewportWidth,
                        height: viewportHeight
                    })
                });
            } catch (error) {
                console.error('Click error:', error);
            } finally {
                isProcessing = false;
            }
        });

        // Handle keyboard
        document.addEventListener('keydown', async (event) => {
            if (isProcessing || event.target.tagName === 'INPUT') return;

            // Handle F5 or Ctrl+R for refresh
            if (event.key === 'F5' || (event.ctrlKey && event.key === 'r')) {
                event.preventDefault();
                await fetch(`${SERVER_URL}/reload`, { method: 'POST' });
                return;
            }

            // Type keys
            if (event.key.length === 1 || ['Enter', 'Backspace', 'Tab'].includes(event.key)) {
                event.preventDefault();

                isProcessing = true;

                try {
                    await fetch(`${SERVER_URL}/type`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ key: event.key })
                    });
                } catch (error) {
                    console.error('Type error:', error);
                } finally {
                    isProcessing = false;
                }
            }
        });

        // Handle scroll
        document.getElementById('liveView').addEventListener('wheel', async (event) => {
            if (isProcessing) return;

            event.preventDefault();
            isProcessing = true;

            try {
                await fetch(`${SERVER_URL}/scroll`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        deltaX: event.deltaX,
                        deltaY: event.deltaY
                    })
                });
            } catch (error) {
                console.error('Scroll error:', error);
            } finally {
                isProcessing = false;
            }
        }, { passive: false });

        // Handle zoom (Ctrl+Wheel)
        let currentZoom = 1.0;
        document.addEventListener('wheel', async (event) => {
            if (event.ctrlKey && !isProcessing) {
                event.preventDefault();

                const zoomDelta = event.deltaY > 0 ? -0.1 : 0.1;
                currentZoom = Math.max(0.5, Math.min(3.0, currentZoom + zoomDelta));

                isProcessing = true;

                try {
                    await fetch(`${SERVER_URL}/zoom`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ scale: currentZoom })
                    });
                } catch (error) {
                    console.error('Zoom error:', error);
                } finally {
                    isProcessing = false;
                }
            }
        }, { passive: false });

        // Handle resize
        window.addEventListener('resize', () => {
            viewportWidth = window.innerWidth;
            viewportHeight = window.innerHeight;
        });
    </script>
</body>
</html>
